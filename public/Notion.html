<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quick Notes - Notion IQ</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .notes-layout{display:flex;gap:2rem;max-width:1200px;margin:0 auto;padding:2rem}
    .notes-main{flex:2}
    .important-points{flex:1;background:rgba(10,5,20,.5);padding:2rem;border-radius:12px;border:1px solid rgba(158,0,255,.3);height:fit-content;position:sticky;top:100px}
    .important-points h3{color:#fff;margin-bottom:1rem;font-size:1.5rem}
    .important-points ul{list-style:none;padding:0}
    .important-points li{color:#e0e0e0;margin:1rem 0;padding-left:1.5rem;position:relative;line-height:1.6}
    .important-points li:before{content:"‚Ä¢";color:rgb(158,0,255);position:absolute;left:0;font-size:1.5rem}
    .point-number{color:#9E00FF;font-weight:600;margin-right:.5rem}
    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(158,0,255,.3);border-radius:50%;border-top-color:#9E00FF;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ai-badge{display:inline-block;background:linear-gradient(90deg,#9E00FF,#BF6FFF);padding:.3rem .8rem;border-radius:20px;font-size:.8rem;margin-left:.5rem;color:#fff;font-weight:600}
    .small-muted{font-size:.9rem;color:#cfcfcf;margin-top:.5rem}
    .info-box {
      background: rgba(158,0,255,0.1);
      border-left: 3px solid #9E00FF;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
    }
    .button-group {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
<header>
  <nav>
    <div class="logo">
  <img src="/logo.svg" alt="Notion IQ Logo" class="logo-img">
  <span class="logo-text">Notion IQ</span>
</div>

    <ul></ul>
  </nav>
</header>

<main>
  <div class="notes-layout">
    <div class="notes-main">
      <div class="signin-page-wrapper">
        <div class="content-box reveal-on-scroll visible">
          <h2><!-- Add this to your Notion.html, right after the <h2>Quick Notes Analyzer</h2> tag -->

<div id="usage-widget" style="background: rgba(158,0,255,0.1); border: 1px solid rgba(158,0,255,0.3); border-radius: 8px; padding: 15px; margin: 15px 0; display: none;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <div>
      <strong>Daily Usage:</strong> 
      <span id="usage-text">0 / 10</span>
      <span id="tier-badge" style="background: linear-gradient(90deg, #9E00FF, #BF6FFF); padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px;">Free</span>
    </div>
    <a href="/usage.html" style="color: #BF6FFF; text-decoration: none; font-size: 0.9rem;">View Details ‚Üí</a>
  </div>
  <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
    <div id="usage-bar" style="height: 100%; background: linear-gradient(90deg, #9E00FF, #BF6FFF); width: 0%; transition: width 0.3s;"></div>
  </div>
  <p id="usage-message" style="margin-top: 8px; font-size: 0.85rem; color: #bbb;"></p>
</div>

<!-- Add this script at the end of Notion.html, before the closing </body> tag -->
<script>
(function() {
  const usageWidget = document.getElementById('usage-widget');
  const usageText = document.getElementById('usage-text');
  const usageBar = document.getElementById('usage-bar');
  const usageMessage = document.getElementById('usage-message');
  const tierBadge = document.getElementById('tier-badge');

  async function updateUsage() {
    try {
      const res = await fetch('/api/my-usage', { credentials: 'include' });
      if (!res.ok) return; // User not logged in or error
      
      const data = await res.json();
      
      // Show widget
      usageWidget.style.display = 'block';
      
      // Update text
      usageText.textContent = `${data.usage.today} / ${data.limits.daily}`;
      
      // Update tier badge
      tierBadge.textContent = data.tier.charAt(0).toUpperCase() + data.tier.slice(1);
      if (data.tier === 'premium') {
        tierBadge.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
        tierBadge.style.color = '#000';
      }
      
      // Update progress bar
      const percentage = (data.usage.today / data.limits.daily) * 100;
      usageBar.style.width = `${Math.min(100, percentage)}%`;
      
      // Update bar color based on usage
      if (percentage > 80) {
        usageBar.style.background = 'linear-gradient(90deg, #FF0000, #CC0000)';
      } else if (percentage > 60) {
        usageBar.style.background = 'linear-gradient(90deg, #FF6B00, #FF9500)';
      }
      
      // Update message
      if (data.remaining <= 0) {
        usageMessage.textContent = '‚ö†Ô∏è Daily limit reached! ' + 
          (data.canUpgrade ? 'Upgrade to premium for 10x more requests!' : 'Resets at midnight.');
        usageMessage.style.color = '#ff6b6b';
      } else if (data.remaining <= 3) {
        usageMessage.textContent = `‚ö†Ô∏è Only ${data.remaining} requests left today!`;
        usageMessage.style.color = '#ffa500';
      } else {
        usageMessage.textContent = `${data.remaining} requests remaining today`;
        usageMessage.style.color = '#bbb';
      }
      
    } catch (err) {
      console.error('Failed to load usage:', err);
    }
  }
  
  // Update on page load
  updateUsage();
  
  // Update after each API call
  const originalFetch = window.fetch;
  window.fetch = function(...args) {
    return originalFetch.apply(this, args).then(response => {
      if (args[0].includes('/api/analyze') || 
          args[0].includes('/api/generate-quiz') || 
          args[0].includes('/api/analyze-pages')) {
        setTimeout(updateUsage, 500);
      }
      return response;
    });
  };
})();
</script>Quick Notes Analyzer <span class="ai-badge">AI Powered</span></h2>
          

          <div class="info-box">
            <strong>‚ö° Quick Analysis:</strong><br>
            Extract 7 key points from your notes instantly. Perfect for quick review and quiz generation.
            <br><br>
            <strong>Need more detail?</strong> Use <a href="/detailed-analysis.html" style="color: #BF6FFF;">Detailed Analysis</a> for comprehensive, page-by-page study guides.
          </div>

          <div id="file-upload-section">
            <p>Upload your notes or paste text below</p>
            <textarea id="notes-input" placeholder="Paste your notes here..." class="quiz-textarea"></textarea>

            <input type="file" id="file-upload" accept=".txt,.docx,.pdf" class="file-input">
            <button id="extract-file" class="cta-button" style="background: rgba(255,255,255,0.1); border:1px solid #666;">
              Extract Text from File
            </button>

            <div class="button-group">
              <button id="analyze-notes" class="cta-button">
                <span id="analyze-text">üîç Analyze & Extract Key Points</span>
                <span id="analyze-loading" class="loading" style="display:none;"></span>
              </button>

              <button id="generate-quiz-from-points" class="cta-button" style="display:none;">
                <span id="quiz-from-points-text">üìù Generate Quiz from Points</span>
                <span id="quiz-from-points-loading" class="loading" style="display:none;"></span>
              </button>

              <button id="generate-quiz" class="cta-button" style="display:none;">
                <span id="quiz-text">üìù Generate Quiz from Full Notes</span>
                <span id="quiz-loading" class="loading" style="display:none;"></span>
              </button>
            </div>

            <p class="small-muted">
              <strong>How it works:</strong> Click "Analyze" to extract key points ‚Üí Review them ‚Üí Generate a quiz!
            </p>
          </div>

          <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <h3 style="margin-bottom: 1rem;">üìö Or try our other tools:</h3>
            <a href="/detailed-analysis.html" class="cta-button" style="display:inline-block; text-decoration:none;">
              Generate Detailed Study Guide (10+ points per page)
            </a>
          </div>

          <a href="index.html" class="back-link">‚Üê Back to Home</a>
        </div>
      </div>
    </div>

    <div class="important-points" id="important-points">
      <h3>üîç AI-Extracted Key Points</h3>
      <ul id="important-points-list">
        <li id="no-points">No key points yet. Click <strong>"Analyze & Extract Key Points"</strong> to get started.</li>
      </ul>
    </div>
  </div>
</main>

<script>
  const notesInput = document.getElementById('notes-input');
  const fileUpload = document.getElementById('file-upload');
  const extractBtn = document.getElementById('extract-file');
  const analyzeBtn = document.getElementById('analyze-notes');
  const generateQuizBtn = document.getElementById('generate-quiz');
  const generateQuizFromPointsBtn = document.getElementById('generate-quiz-from-points');

  const importantPointsList = document.getElementById('important-points-list');
  const analyzeText = document.getElementById('analyze-text');
  const analyzeLoading = document.getElementById('analyze-loading');

  // --- Display Points & Update Nav ---
  function showImportantPoints(pointsArray) {
    importantPointsList.innerHTML = '';

    if (!Array.isArray(pointsArray) || pointsArray.length === 0) {
      importantPointsList.innerHTML = '<li>No important points found. Try different content.</li>';
      sessionStorage.removeItem('notioniq_important_points');
      generateQuizFromPointsBtn.style.display = 'none';
      return;
    }

    pointsArray.forEach((p, i) => {
      const li = document.createElement('li');
      li.innerHTML = `<span class="point-number">${i + 1}.</span> ${p}`;
      importantPointsList.appendChild(li);
    });

    sessionStorage.setItem('notioniq_important_points', JSON.stringify(pointsArray));
    generateQuizFromPointsBtn.style.display = 'inline-block';
    generateQuizBtn.style.display = 'inline-block';

    if (window._NotionIQAuth && window._NotionIQAuth.updateNav) {
      window._NotionIQAuth.updateNav();
    }
  }

  // --- 1. Extract Text from File (NO AI) ---
  extractBtn.addEventListener('click', async () => {
    const file = fileUpload.files[0];
    if (!file) { 
      alert('Please select a file first'); 
      return; 
    }

    extractBtn.textContent = 'Extracting...';
    extractBtn.disabled = true;

    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await fetch('/api/extract-text', { method: 'POST', body: formData });
      const data = await res.json();
      
      if (data.success) {
        notesInput.value = data.text;
        generateQuizBtn.style.display = 'inline-block';
        alert('Text extracted successfully! Now click "Analyze" to extract key points.');
      } else {
        alert(data.message || 'Extraction failed');
      }
    } catch (err) {
      console.error(err);
      alert('Error extracting text');
    } finally {
      extractBtn.textContent = 'Extract Text from File';
      extractBtn.disabled = false;
    }
  });

  // --- 2. Analyze (Extract Important Points with AI) ---
  analyzeBtn.addEventListener('click', async () => {
    const notes = notesInput.value.trim();
    if (!notes || notes.length < 50) { 
      alert('Please enter at least 50 characters of notes or extract a file first.'); 
      return; 
    }

    analyzeText.style.display = 'none';
    analyzeLoading.style.display = 'inline-block';
    analyzeBtn.disabled = true;

    try {
      const res = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes })
      });
      const data = await res.json();
      
      if (data.success && data.points) {
        showImportantPoints(data.points);
        document.getElementById('important-points').scrollIntoView({ behavior: 'smooth' });
      } else {
        alert(data.message || 'Analysis failed. Please try again.');
      }
    } catch (err) {
      console.error(err);
      alert('Error connecting to server');
    } finally {
      analyzeText.style.display = 'inline';
      analyzeLoading.style.display = 'none';
      analyzeBtn.disabled = false;
    }
  });

  // --- 3. Generate Quiz (Common Logic) ---
  async function handleQuizGeneration(textToUse, btnId, textSpanId, loadSpanId) {
    const btn = document.getElementById(btnId);
    const textSpan = document.getElementById(textSpanId);
    const loadSpan = document.getElementById(loadSpanId);

    if (!textToUse || textToUse.length < 50) {
      alert('Not enough content to generate a quiz. Need at least 50 characters.');
      return;
    }

    textSpan.style.display = 'none';
    loadSpan.style.display = 'inline-block';
    btn.disabled = true;

    try {
      const res = await fetch('/api/generate-quiz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: textToUse })
      });
      const data = await res.json();
      
      if (data.success && data.questions) {
        sessionStorage.setItem('aiQuizQuestions', JSON.stringify(data.questions));
        if (window._NotionIQAuth && window._NotionIQAuth.updateNav) {
          window._NotionIQAuth.updateNav();
        }
        window.location.href = '/take-quiz.html';
      } else {
        alert(data.message || 'Quiz generation failed');
      }
    } catch (err) {
      console.error(err);
      alert('Error generating quiz');
    } finally {
      textSpan.style.display = 'inline';
      loadSpan.style.display = 'none';
      btn.disabled = false;
    }
  }

  // --- Quiz Button Listeners ---
  generateQuizBtn.addEventListener('click', () => {
    handleQuizGeneration(notesInput.value, 'generate-quiz', 'quiz-text', 'quiz-loading');
  });

  generateQuizFromPointsBtn.addEventListener('click', () => {
    const points = JSON.parse(sessionStorage.getItem('notioniq_important_points') || '[]');
    const text = points.join('\n');
    handleQuizGeneration(text, 'generate-quiz-from-points', 'quiz-from-points-text', 'quiz-from-points-loading');
  });

  // --- On Load: Restore State ---
  document.addEventListener('DOMContentLoaded', () => {
    const savedPoints = sessionStorage.getItem('notioniq_important_points');
    if (savedPoints) {
      showImportantPoints(JSON.parse(savedPoints));
    }
    
    if (window.location.hash === '#important-points') {
      setTimeout(() => {
        document.getElementById('important-points').scrollIntoView({ behavior: 'smooth' });
      }, 500);
    }
  });
</script>

<script src="script.js" defer></script>
</body>
</html>